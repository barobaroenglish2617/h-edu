// ==========================================
// 1. Supabase ì„¤ì •
// ==========================================
const SUPABASE_URL = 'https://otygcwbxbbtsnuvhwcqt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90eWdjd2J4YmJ0c251dmh3Y3F0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxODQ0NjcsImV4cCI6MjA3OTc2MDQ2N30.ck2UU7v2SfxXD8snUrpyek9Q6PbCjR76NWfdoEHn2Lg';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ==========================================
// 2. ìƒíƒœ ë³€ìˆ˜ (State)
// ==========================================
const state = {
    storyId: null,
    data: null,
    currentPage: 0,
    totalPages: 0,
    processedData: {
        title: "",
        images: [],
        texts: [],
        words: [],     // ì—¬ê¸°ì— DBì—ì„œ ê°€ì ¸ì˜¨ ë‹¨ì–´ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.
        audioUrl: ""
    }
};

// ==========================================
// 3. ì‹œì‘ (ì´ˆê¸°í™”)
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    // URLì—ì„œ ?id=ìˆ«ì ê°€ì ¸ì˜¤ê¸°
    const params = new URLSearchParams(window.location.search);
    state.storyId = params.get('id');

    if (!state.storyId) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        return;
    }

    await fetchStoryData(state.storyId);
});

// ==========================================
// 4. DBì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í•µì‹¬!)
// ==========================================
async function fetchStoryData(id) {
    try {
        // DBì˜ 'stories' í…Œì´ë¸”ì—ì„œ idê°€ ì¼ì¹˜í•˜ëŠ” ì¤„ì„ ê°€ì ¸ì˜´
        const { data, error } = await supabase
            .from('stories')
            .select('*')
            .eq('sort_order', id)
            .single();

        if (error || !data) throw new Error("ë°ì´í„° ì—†ìŒ");

        // --- [ë°ì´í„° ê°€ê³µ] ---
        
        // 1. ì´ë¯¸ì§€ (DB: "ì£¼ì†Œ1, ì£¼ì†Œ2" -> JS: ["ì£¼ì†Œ1", "ì£¼ì†Œ2"])
        const images = data.page_images 
            ? data.page_images.split(',').map(s => s.trim()) 
            : [data.thumbnail_url];

        // 2. ë¬¸ì¥ (DB: "ë¬¸ì¥1|||ë¬¸ì¥2" -> JS: ["ë¬¸ì¥1", "ë¬¸ì¥2"])
        const texts = data.content 
            ? data.content.split('|||').map(s => s.trim()) 
            : [];

        // 3. ë‹¨ì–´ (DB: "kid, pet, pig" -> JS: ["kid", "pet", "pig"])
        // â˜… ì—¬ê¸°ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤. Story 2ë¥¼ ë¶€ë¥´ë©´ Story 2ì˜ ë‹¨ì–´ê°€ ìë™ìœ¼ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤.
        let words = [];
        if (data.words) {
            // DBì— ë‹¨ì–´ê°€ ì½¤ë§ˆ(,)ë¡œ ì í˜€ìˆë“  ë°°ì—´ì´ë“  ì•Œì•„ì„œ ì²˜ë¦¬
            words = typeof data.words === 'string' 
                ? data.words.split(',').map(w => w.trim()) 
                : data.words;
        } else {
            // DBì— ë‹¨ì–´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ (í™”ë©´ì— ì•„ë¬´ê²ƒë„ ì•ˆ ëœ¸)
            console.warn("ì´ ìŠ¤í† ë¦¬ì— ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        // 4. ì œëª© ì •ë¦¬ (Story 1. Story 1... ì¤‘ë³µ ë°©ì§€)
        let cleanTitle = data.title;
        const prefix = `Story ${data.sort_order}`;
        if (!cleanTitle.toLowerCase().startsWith('story')) {
            cleanTitle = `${prefix}. ${cleanTitle}`;
        }

        // --- ìƒíƒœ ì €ì¥ ---
        state.processedData = {
            title: cleanTitle,
            images: images,
            texts: texts,
            words: words,
            audioUrl: data.audio_url
        };
        
        state.totalPages = 1 + Math.max(images.length, texts.length);

        // ì˜¤ë””ì˜¤ ì¤€ë¹„
        if (state.processedData.audioUrl) {
            document.getElementById('bg-audio').src = state.processedData.audioUrl;
        }

        // í™”ë©´ ê·¸ë¦¬ê¸° ì‹œì‘
        renderView();

    } catch (err) {
        console.error(err);
        alert("ì´ì•¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (DBë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”)");
    }
}

// ==========================================
// 5. í™”ë©´ ê·¸ë¦¬ê¸° (Render)
// ==========================================
function renderView() {
    const { currentPage, totalPages, processedData } = state;
    
    // ì œëª© & í˜ì´ì§€ ë²ˆí˜¸
    document.getElementById('title-el').innerText = processedData.title;
    document.getElementById('page-el').innerText = `Page ${currentPage + 1} / ${totalPages}`;

    // ì „ì²´ ë“£ê¸° ë²„íŠ¼ (0í˜ì´ì§€ & ì˜¤ë””ì˜¤ ìˆì„ ë•Œë§Œ ë³´ì„)
    const audioBtn = document.getElementById('audio-btn-el');
    if (currentPage === 0 && processedData.audioUrl) {
        audioBtn.classList.add('active'); 
    } else {
        audioBtn.classList.remove('active');
    }

    // ë²„íŠ¼ ìƒíƒœ
    document.getElementById('prev-btn').disabled = (currentPage === 0);
    const nextBtn = document.getElementById('next-btn');
    
    if (currentPage === totalPages - 1) {
        nextBtn.innerText = "Finish";
        nextBtn.onclick = () => history.back();
    } else {
        nextBtn.innerText = "Next";
        nextBtn.onclick = () => changePage(1);
    }

    // --- ë‚´ìš© ê°ˆì•„ë¼ìš°ê¸° ---
    const imgEl = document.getElementById('img-el');
    const contentBox = document.getElementById('dynamic-content');

    // ì´ë¯¸ì§€
    const imgIndex = currentPage === 0 ? 0 : currentPage - 1;
    imgEl.src = processedData.images[imgIndex] || processedData.images[0] || '';

    // ë‚´ìš© (ë‹¨ì–´ì¥ vs ë¬¸ì¥)
    if (currentPage === 0) {
        // 0í˜ì´ì§€: ë‹¨ì–´ì¥ ê·¸ë¦¬ê¸°
        contentBox.innerHTML = generateWordGrid(processedData.words);
    } else {
        // ë‚˜ë¨¸ì§€: ë¬¸ì¥ ë³´ì—¬ì£¼ê¸°
        const sentence = processedData.texts[currentPage - 1] || "";
        contentBox.innerHTML = `<div class="mode-sentence">${sentence}</div>`;
    }
}

// ==========================================
// 6. ë‹¨ì–´ì¥ HTML ìƒì„±ê¸°
// ==========================================
function generateWordGrid(wordList) {
    if (!wordList || wordList.length === 0) {
        return '<div style="color:#999;">ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    let html = '<div class="mode-word-grid">';
    wordList.forEach(word => {
        // ë‹¨ì–´ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ playWordSound í•¨ìˆ˜ ì‹¤í–‰
        html += `
            <div class="word-card" onclick="playWordSound('${word}')">
                ${word}
            </div>
        `;
    });
    html += '</div>';
    return html;
}

// ==========================================
// 7. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
// ==========================================

// í˜ì´ì§€ ì´ë™
function changePage(step) {
    const next = state.currentPage + step;
    if (next >= 0 && next < state.totalPages) {
        state.currentPage = next;
        renderView();
    }
}

// ì „ì²´ ë“£ê¸°
function toggleFullAudio() {
    const audio = document.getElementById('bg-audio');
    const btn = document.getElementById('audio-btn-el');

    if (!state.processedData.audioUrl) return;

    if (audio.paused) {
        audio.play();
        btn.innerHTML = "â¸ ë“£ê¸° ì¤‘ë‹¨";
        btn.classList.add('playing');
    } else {
        audio.pause();
        btn.innerHTML = "ğŸ”Š ì „ì²´ ë“£ê¸°";
        btn.classList.remove('playing');
    }
}

// ë‹¨ì–´ ê°œë³„ ë“£ê¸°
function playWordSound(word) {
    // íŒŒì¼ëª… ê·œì¹™: ì†Œë¬¸ìë¡œ ë³€í™˜ (Ant -> ant.mp3)
    const cleanWord = word.trim().toLowerCase();
    const audio = new Audio(`audio/${cleanWord}.mp3`);
    audio.play().catch(e => console.log('ë‹¨ì–´ ìŒì› ì—†ìŒ:', cleanWord));
}
