<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story View - Blossom English</title>

    <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Pretendard Variable", sans-serif; }
        body {
            background: #f4f6fb;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .viewer-container {
            width: 100%;
            max-width: 950px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 40px;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 600px;
        }

        /* ===== ÏÉÅÎã® Î≤ÑÌäº ===== */
        .top-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        .top-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            background: #f1f3f5;
            color: #555;
        }

        .top-btn.home { background: #dbeafe; color: #1d4ed8; }
        .top-btn.retry { background: #ede9fe; color: #5b21b6; }
        .top-btn.back { background: #fee2e2; color: #991b1b; }

        /* ===== Ìó§Îçî ===== */
        .story-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f4f6fb;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .header-left { display: flex; flex-direction: column; }

        .story-title {
            font-size: 2rem;
            font-weight: 800;
        }

        .page-indicator {
            margin-top: 6px;
            color: #888;
            font-weight: 600;
        }

        .play-all-btn {
            background: #eee;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
        }

        .play-all-btn.playing {
            background: #5D5FEF;
            color: white;
        }

        /* ===== ÏΩòÌÖêÏ∏† ===== */
        .content-wrapper {
            flex: 1;
            display: flex;
            gap: 40px;
        }

        .image-area {
            flex: 1;
            border-radius: 20px;
            overflow: hidden;
            background: #fafafa;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .story-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-placeholder {
            color: #aaa;
            font-size: 1.2rem;
        }

        .text-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .story-text {
            background: #FFFDE7;
            padding: 30px;
            border-radius: 20px;
            font-size: 1.8rem;
            font-weight: 600;
            line-height: 1.6;
            width: 100%;
        }

        .word-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }

        .word-card {
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #eee;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .word-card:hover {
            border-color: #5D5FEF;
            color: #5D5FEF;
        }

        .nav-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
        }

        .nav-btn.prev { background: #f1f3f5; }
        .nav-btn.next { background: #5D5FEF; color: white; }
    </style>
</head>

<body>
<div class="viewer-container">

    <!-- ÏÉÅÎã® Î≤ÑÌäº -->
    <div class="top-buttons">
        <button class="top-btn home" onclick="goHome()">Home</button>
        <button class="top-btn retry" onclick="restartStory()">Îã§ÏãúÌíÄÍ∏∞</button>
        <button class="top-btn back" onclick="history.back()">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    </div>

    <audio id="bg-audio"></audio>

    <header class="story-header">
        <div class="header-left">
            <h1 id="display-title" class="story-title">Loading...</h1>
            <div id="page-indicator" class="page-indicator"></div>
        </div>
        <button id="header-play-btn" class="play-all-btn" onclick="toggleFullAudio()">üîä Story Full Audio</button>
    </header>

    <div class="content-wrapper">
        <div class="image-area" id="image-area">
            <img id="story-img" class="story-img" />
            <div id="image-placeholder" class="image-placeholder" style="display:none;">
                Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑÏ§ë
            </div>
        </div>

        <div id="text-area" class="text-area"></div>
    </div>

    <div class="nav-controls">
        <button id="btn-prev" class="nav-btn prev" onclick="changePage(-1)">Previous</button>
        <button id="btn-next" class="nav-btn next" onclick="changePage(1)">Next</button>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://otygcwbxbbtsnuvhwcqt.supabase.co';
const SUPABASE_KEY = 'YOUR_KEY';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let storyData = {};
let currentPage = 0;
let totalPages = 0;

const bgAudio = document.getElementById('bg-audio');
const playBtn = document.getElementById('header-play-btn');

document.addEventListener('DOMContentLoaded', loadStory);

async function loadStory() {
    const id = new URLSearchParams(location.search).get('id');
    const { data } = await supabaseClient.from('stories').select('*').eq('sort_order', id).single();

    storyData = {
        title: data.title,
        number: data.sort_order,
        images: data.page_images.split(',').map(v => v.trim()),
        texts: data.content.split('|||').map(v => v.trim()),
        words: data.words?.split(',') || [],
        audioUrl: data.audio_url
    };

    if (storyData.audioUrl) bgAudio.src = storyData.audioUrl;
    totalPages = 1 + storyData.texts.length;
    renderPage(0);
}

function renderPage(index) {
    currentPage = index;
    document.getElementById('display-title').innerText =
        `Story ${storyData.number}. ${storyData.title}`;
    document.getElementById('page-indicator').innerText =
        `Page ${index + 1} / ${totalPages}`;

    const img = document.getElementById('story-img');
    const placeholder = document.getElementById('image-placeholder');
    const text = document.getElementById('text-area');

    if (storyData.images[index]) {
        img.src = storyData.images[index];
        img.style.display = 'block';
        placeholder.style.display = 'none';
    } else {
        img.style.display = 'none';
        placeholder.style.display = 'block';
    }

    if (index === 0) {
        text.innerHTML = `<div class="word-grid">
            ${storyData.words.map(w => `<div class="word-card">${w}</div>`).join('')}
        </div>`;
    } else {
        text.innerHTML = `<div class="story-text">${storyData.texts[index - 1]}</div>`;
    }

    document.getElementById('btn-prev').disabled = index === 0;
}

function changePage(step) {
    const next = currentPage + step;
    if (next >= 0 && next < totalPages) renderPage(next);
}

function toggleFullAudio() {
    if (bgAudio.paused) {
        bgAudio.play();
        playBtn.classList.add('playing');
        playBtn.innerText = '‚è∏ Pause';
    } else {
        bgAudio.pause();
        playBtn.classList.remove('playing');
        playBtn.innerText = 'üîä Story Full Audio';
    }
}

function restartStory() {
    renderPage(0);
}

function goHome() {
    location.href = 'story_list.html';
}
</script>
</body>
</html>
