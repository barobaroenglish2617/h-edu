// story_view.js  (Supabase ì—°ë™ + story_view.htmlì˜ idì— ë§ì¶˜ ë²„ì „)

// Supabase ì„¤ì •
const SUPABASE_URL = 'https://otygcwbxbbtsnuvhwcqt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90eWdjd2J4YmJ0c251dmh3Y3F0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxODQ0NjcsImV4cCI6MjA3OTc2MDQ2N30.ck2UU7v2SfxXD8snUrpyek9Q6PbCjR76NWfdoEHn2Lg';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Storage ë²„í‚·
const IMAGE_BUCKET = 'image';

let storyData = {
  title: '',
  number: 0,
  images: [],
  texts: [],
  words: [],
  audioUrl: ''
};

let currentPage = 0;
let totalPages = 0;

const bgAudio = document.getElementById('bg-audio');
const playBtn = document.getElementById('header-play-btn');

document.addEventListener('DOMContentLoaded', loadStory);

/** ---------------------------------------
 * ìœ í‹¸
 * --------------------------------------*/
function isHttpUrl(v) {
  return typeof v === 'string' && (v.startsWith('http://') || v.startsWith('https://'));
}

// DBì—ì„œ ê°€ì ¸ì˜¨ ë¬¸ìì—´ì´ "'https://...'" ì²˜ëŸ¼ ë”°ì˜´í‘œ í¬í•¨ì¼ ìˆ˜ ìˆì–´ì„œ ì œê±°
function normalizeToken(v) {
  if (!v) return '';
  let s = String(v).trim();

  // ì¤„ë°”ê¿ˆ/íƒ­ ì œê±°
  s = s.replace(/\r?\n|\r|\t/g, '').trim();

  // ì–‘ë ë”°ì˜´í‘œ ì œê±° ('...' ë˜ëŠ” "...")
  if ((s.startsWith("'") && s.endsWith("'")) || (s.startsWith('"') && s.endsWith('"'))) {
    s = s.slice(1, -1).trim();
  }
  return s;
}

function toPublicImageUrl(fileOrUrl) {
  const token = normalizeToken(fileOrUrl);
  if (!token) return '';

  // ì´ë¯¸ URLì´ë©´ ê·¸ëŒ€ë¡œ
  if (isHttpUrl(token)) return token;

  // íŒŒì¼ëª…/ê²½ë¡œì´ë©´ ë²„í‚· public url ìƒì„±
  const { data } = supabaseClient.storage.from(IMAGE_BUCKET).getPublicUrl(token);
  return data?.publicUrl || '';
}

function safeSplitCommaList(value) {
  if (!value) return [];
  return String(value)
    .split(',')
    .map(normalizeToken)
    .filter(Boolean);
}

/** ---------------------------------------
 * ë©”ì¸ ë¡œë“œ
 * --------------------------------------*/
async function loadStory() {
  try {
    const params = new URLSearchParams(window.location.search);
    const targetId = params.get('id');

    if (!targetId) {
      alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (URLì— idê°€ ì—†ìŒ)");
      return;
    }

    const { data, error } = await supabaseClient
      .from('stories')
      .select('*')
      .eq('sort_order', targetId)
      .single();

    if (error || !data) {
      console.error('Supabase error:', error);
      alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
      return;
    }

    // 1) ì´ë¯¸ì§€ ëª©ë¡
    // page_images: "1-1.png,1-2.png,..." ë˜ëŠ” "https://...,..."
    const rawImages = data.page_images
      ? safeSplitCommaList(data.page_images)
      : (data.thumbnail_url ? [normalizeToken(data.thumbnail_url)] : []);

    const images = rawImages.map(toPublicImageUrl).filter(Boolean);

    // 2) ë¬¸ì¥(ìŠ¤í† ë¦¬ ë‚´ìš©)
    const texts = data.content
      ? String(data.content).split('|||').map(s => s.trim()).filter(Boolean)
      : [];

    // 3) ë‹¨ì–´ ëª©ë¡
    let words = [];
    if (data.words && typeof data.words === 'string') {
      words = safeSplitCommaList(data.words);
    } else if (Array.isArray(data.words)) {
      words = data.words.map(w => normalizeToken(w)).filter(Boolean);
    }

    // ë‹¨ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
    if (!words.length) {
      words = ["ant", "apple", "egg", "elf", "owl", "ox", "up", "upset", "it", "bed", "bell"];
    }

    storyData = {
      title: data.title || '',
      number: data.sort_order || Number(targetId),
      images,
      texts,
      words,
      audioUrl: normalizeToken(data.audio_url || '')
    };

    if (storyData.audioUrl) bgAudio.src = storyData.audioUrl;

    // ì´ í˜ì´ì§€: 0(ë‹¨ì–´ì¥) + ìŠ¤í† ë¦¬ í˜ì´ì§€ ìˆ˜
    totalPages = 1 + Math.max(storyData.images.length, storyData.texts.length);
    if (totalPages < 1) totalPages = 1;

    renderPage(0);
  } catch (e) {
    console.error('loadStory exception:', e);
    alert("ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
  }
}

/** ---------------------------------------
 * ë Œë”ë§
 * --------------------------------------*/
function renderPage(index) {
  currentPage = index;

  // ì œëª©
  let fullTitle = storyData.title || '';
  const prefix = `Story ${storyData.number}`;
  if (fullTitle && !fullTitle.toLowerCase().includes(prefix.toLowerCase())) {
    fullTitle = `${prefix}. ${fullTitle}`;
  } else if (!fullTitle) {
    fullTitle = prefix;
  }

  document.getElementById('display-title').innerText = fullTitle;
  document.getElementById('page-indicator').innerText = `Page ${currentPage + 1} / ${totalPages}`;

  // ì˜¤ë””ì˜¤ ë²„íŠ¼: 0í˜ì´ì§€ + ì˜¤ë””ì˜¤ ìˆì„ ë•Œë§Œ
  if (index === 0 && storyData.audioUrl) {
    playBtn.style.display = 'flex';
  } else {
    playBtn.style.display = 'none';
    bgAudio.pause();
    playBtn.innerHTML = `<span>ğŸ”Š Story Full Audio</span>`;
    playBtn.classList.remove('playing');
  }

  const imgEl = document.getElementById('story-img');
  const textEl = document.getElementById('text-area');

  // ì´ë¯¸ì§€ ì„ íƒ
  let imgSrc = '';
  if (index === 0) {
    imgSrc = storyData.images[0] || '';
  } else {
    const arrayIndex = index - 1;
    imgSrc = storyData.images[arrayIndex] || storyData.images[0] || '';
  }

  // ì´ë¯¸ì§€ ì—ëŸ¬ ì²˜ë¦¬
  imgEl.onerror = function () {
    this.onerror = null;
    this.src = 'https://via.placeholder.com/600x400?text=Image+Not+Found';
  };
  imgEl.src = imgSrc;

  // í˜ì´ì§€ ë‚´ìš©
  if (index === 0) {
    // ë‹¨ì–´ì¥
    let html = '<div class="word-grid">';
    storyData.words.forEach(word => {
      const safeWord = String(word).replace(/'/g, "\\'");
      html += `<div class="word-card" onclick="playWordAudio('${safeWord}')">${word}</div>`;
    });
    html += '</div>';
    textEl.innerHTML = html;
  } else {
    // ë¬¸ì¥
    const sentence = storyData.texts[index - 1] || '...';
    textEl.innerHTML = `<div class="story-text">${sentence}</div>`;
  }

  // ë„¤ë¹„ ë²„íŠ¼
  document.getElementById('btn-prev').disabled = (index === 0);

  const nextBtn = document.getElementById('btn-next');
  if (index === totalPages - 1) {
    nextBtn.innerText = "Finish";
    nextBtn.onclick = () => goBack();
  } else {
    nextBtn.innerText = "Next";
    nextBtn.onclick = () => changePage(1);
  }
}

function changePage(step) {
  const newPage = currentPage + step;
  if (newPage >= 0 && newPage < totalPages) renderPage(newPage);
}

/** ---------------------------------------
 * ë²„íŠ¼ ë™ì‘
 * --------------------------------------*/
function toggleFullAudio() {
  if (bgAudio.paused) {
    bgAudio.play();
    playBtn.innerHTML = "<span>â¸ Pause Audio</span>";
    playBtn.classList.add('playing');
  } else {
    bgAudio.pause();
    playBtn.innerHTML = "<span>ğŸ”Š Story Full Audio</span>";
    playBtn.classList.remove('playing');
  }
}

function playWordAudio(word) {
  const cleanWord = word.trim().toLowerCase();
  const audio = new Audio(`audio/${cleanWord}.mp3`);
  audio.play();
}

function restartStory() {
  renderPage(0);
}
function goBack() {
  history.back();
}
function goHome() {
  window.location.href = 'index.html';
}

// HTML onclickì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì „ì—­ ë“±ë¡
window.toggleFullAudio = toggleFullAudio;
window.playWordAudio = playWordAudio;
window.changePage = changePage;
window.restartStory = restartStory;
window.goBack = goBack;
window.goHome = goHome;
