import { useEffect, useMemo, useState } from "react";
import { createClient } from "@supabase/supabase-js";

/**
 * 필요 환경변수 (Vite 기준)
 * .env
 * VITE_SUPABASE_URL=...
 * VITE_SUPABASE_ANON_KEY=...
 */
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

const supabase = createClient(supabaseUrl, supabaseAnonKey);

export default function StoryView() {
  const [loading, setLoading] = useState(true);
  const [stories, setStories] = useState([]);
  const [selected, setSelected] = useState(null);
  const [classId, setClassId] = useState(""); // 반별로 나누고 싶으면 사용

  useEffect(() => {
    if (!supabaseUrl || !supabaseAnonKey) {
      alert("Supabase 환경변수가 비어있어요: VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY");
      return;
    }
  }, []);

  useEffect(() => {
    let mounted = true;

    async function fetchStories() {
      setLoading(true);

      // audio_library 테이블에서 목록 가져오기
      // 컬럼: id, title, file_path, sort_order, class_id
      let query = supabase
        .from("audio_library")
        .select("id, title, file_path, sort_order, class_id")
        .order("sort_order", { ascending: true });

      if (classId.trim()) {
        query = query.eq("class_id", classId.trim());
      }

      const { data, error } = await query;

      if (!mounted) return;

      if (error) {
        console.error(error);
        alert("스토리 목록을 불러오지 못했어요. 콘솔을 확인해줘.");
        setStories([]);
        setSelected(null);
        setLoading(false);
        return;
      }

      const list = data ?? [];
      setStories(list);

      // 선택된 게 없으면 첫 번째 자동 선택
      if (list.length > 0) {
        setSelected((prev) => prev ?? list[0]);
      } else {
        setSelected(null);
      }

      setLoading(false);
    }

    fetchStories();

    return () => {
      mounted = false;
    };
  }, [classId]);

  // PUBLIC 버킷이면 getPublicUrl로 재생 URL 생성
  const mediaUrl = useMemo(() => {
    if (!selected?.file_path) return "";
    const { data } = supabase.storage.from("audio").getPublicUrl(selected.file_path);
    return data?.publicUrl || "";
  }, [selected]);

  return (
    <div style={{ maxWidth: 980, margin: "0 auto", padding: 16 }}>
      <header style={{ display: "flex", alignItems: "baseline", justifyContent: "space-between", gap: 12 }}>
        <div>
          <h1 style={{ fontSize: 24, fontWeight: 900, margin: 0 }}>Story View</h1>
          <p style={{ margin: "6px 0 0", color: "#666", fontSize: 13 }}>
            Supabase Storage(audio 버킷)에서 스토리를 불러와 재생합니다.
          </p>
        </div>
      </header>

      {/* 반 필터(원하면 사용) */}
      <div style={{ display: "flex", gap: 8, marginTop: 14 }}>
        <input
          value={classId}
          onChange={(e) => setClassId(e.target.value)}
          placeholder="반 ID(예: A반) — 비우면 전체"
          style={{
            flex: 1,
            padding: "10px 12px",
            borderRadius: 12,
            border: "1px solid #ddd",
            outline: "none",
          }}
        />
        <button
          onClick={() => setClassId("")}
          style={{
            padding: "10px 14px",
            borderRadius: 12,
            border: "1px solid #ddd",
            background: "#fff",
            cursor: "pointer",
            fontWeight: 700,
          }}
        >
          전체
        </button>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "360px 1fr", gap: 14, marginTop: 14 }}>
        {/* 왼쪽: 목록 */}
        <aside style={{ border: "1px solid #eee", borderRadius: 16, padding: 12, background: "#fff" }}>
          <div style={{ fontWeight: 900, marginBottom: 10 }}>목록</div>

          {loading ? (
            <div style={{ padding: 10, color: "#666" }}>불러오는 중…</div>
          ) : stories.length === 0 ? (
            <div style={{ padding: 10, color: "#666" }}>등록된 스토리가 없어요.</div>
          ) : (
            <div style={{ display: "grid", gap: 8 }}>
              {stories.map((s) => {
                const active = selected?.id === s.id;
                return (
                  <button
                    key={s.id}
                    onClick={() => setSelected(s)}
                    style={{
                      textAlign: "left",
                      padding: "10px 12px",
                      borderRadius: 14,
                      border: active ? "1px solid #9cc2ff" : "1px solid #eee",
                      background: active ? "#f2f7ff" : "#fff",
                      cursor: "pointer",
                    }}
                  >
                    <div style={{ fontWeight: 900 }}>
                      {s.sort_order}. {s.title}
                    </div>
                    <div style={{ fontSize: 12, color: "#777", marginTop: 4, wordBreak: "break-all" }}>
                      {s.file_path}
                    </div>
                  </button>
                );
              })}
            </div>
          )}
        </aside>

        {/* 오른쪽: 재생 */}
        <main style={{ border: "1px solid #eee", borderRadius: 16, padding: 12, background: "#fff" }}>
          <div style={{ fontWeight: 900, marginBottom: 10 }}>
            {selected ? `재생: ${selected.title}` : "스토리를 선택해줘"}
          </div>

          {selected && mediaUrl ? (
            <>
              {/* mp4면 video로 재생, mp3면 audio로 바꾸고 싶으면 아래 참고 */}
              <video
                controls
                preload="metadata"
                style={{ width: "100%", borderRadius: 14, background: "#000" }}
                src={mediaUrl}
              />
              <div style={{ marginTop: 10, display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                <a
                  href={mediaUrl}
                  target="_blank"
                  rel="noreferrer"
                  style={{ fontWeight: 800, color: "#1f6feb", textDecoration: "none" }}
                >
                  새 탭에서 열기
                </a>
                <span style={{ color: "#999" }}>|</span>
                <span style={{ fontSize: 12, color: "#666", wordBreak: "break-all" }}>{mediaUrl}</span>
              </div>
            </>
          ) : (
            <div style={{ padding: 10, color: "#666" }}>재생할 항목이 없어요.</div>
          )}

          {/* mp3 전용으로 쓰고 싶으면 video 대신 아래를 사용하면 됨
              <audio controls preload="metadata" style={{ width: "100%" }} src={mediaUrl} />
          */}
        </main>
      </div>
    </div>
  );
}
